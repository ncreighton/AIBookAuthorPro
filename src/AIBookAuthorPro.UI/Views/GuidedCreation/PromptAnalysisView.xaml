<UserControl
    x:Class="AIBookAuthorPro.UI.Views.GuidedCreation.PromptAnalysisView"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
    xmlns:vm="clr-namespace:AIBookAuthorPro.UI.ViewModels.GuidedCreation"
    mc:Ignorable="d"
    d:DataContext="{d:DesignInstance Type=vm:PromptAnalysisViewModel}"
    d:DesignHeight="700"
    d:DesignWidth="900">

    <Grid>
        <!-- Loading State -->
        <Grid Visibility="{Binding IsAnalyzing, Converter={StaticResource BoolToVisibilityConverter}}">
            <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
                <ProgressBar Style="{StaticResource MaterialDesignCircularProgressBar}"
                             Value="{Binding AnalysisProgress}" Maximum="100"
                             Width="80" Height="80"/>
                <TextBlock Text="{Binding AnalysisStatus}"
                           Style="{StaticResource MaterialDesignHeadline6TextBlock}"
                           HorizontalAlignment="Center" Margin="0,24,0,0"/>
                <TextBlock Text="{Binding AnalysisProgress, StringFormat={}{0:F0}% complete}"
                           Style="{StaticResource MaterialDesignBody2TextBlock}"
                           Opacity="0.7" HorizontalAlignment="Center" Margin="0,8,0,0"/>
            </StackPanel>
        </Grid>

        <!-- Analysis Results -->
        <ScrollViewer VerticalScrollBarVisibility="Auto"
                      Visibility="{Binding IsAnalyzing, Converter={StaticResource InverseBoolToVisibilityConverter}}">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <!-- Confidence Overview -->
                <materialDesign:Card Grid.Row="0" Padding="24" Margin="0,0,0,16">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>

                        <StackPanel>
                            <TextBlock Text="Analysis Confidence"
                                       Style="{StaticResource MaterialDesignSubtitle1TextBlock}"/>
                            <StackPanel Orientation="Horizontal" Margin="0,12,0,0">
                                <Border Width="60" Height="60" CornerRadius="30"
                                        Background="{Binding ConfidenceColor}">
                                    <TextBlock Text="{Binding OverallConfidence, StringFormat={}{0:F0}}"
                                               Foreground="White" FontSize="20" FontWeight="Bold"
                                               HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                </Border>
                                <StackPanel Margin="16,0,0,0" VerticalAlignment="Center">
                                    <TextBlock Text="{Binding ConfidenceLevel}"
                                               Style="{StaticResource MaterialDesignHeadline6TextBlock}"/>
                                    <TextBlock Text="Overall analysis confidence"
                                               Style="{StaticResource MaterialDesignCaptionTextBlock}"
                                               Opacity="0.7"/>
                                </StackPanel>
                            </StackPanel>
                        </StackPanel>

                        <Button Grid.Column="1" Content="View Details"
                                Style="{StaticResource MaterialDesignOutlinedButton}"
                                Command="{Binding ToggleDetailedAnalysisCommand}"
                                VerticalAlignment="Top"/>
                    </Grid>
                </materialDesign:Card>

                <!-- Main Analysis Grid -->
                <Grid Grid.Row="1">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="16"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <!-- Left Column -->
                    <StackPanel Grid.Column="0">
                        <!-- Genre & Audience -->
                        <materialDesign:Card Padding="24" Margin="0,0,0,16">
                            <StackPanel>
                                <TextBlock Text="Genre &amp; Audience"
                                           Style="{StaticResource MaterialDesignSubtitle1TextBlock}"
                                           Margin="0,0,0,16"/>
                                
                                <Grid Margin="0,0,0,12">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="120"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Text="Primary Genre:" Opacity="0.7"/>
                                    <TextBlock Grid.Column="1" Text="{Binding DetectedGenre}" FontWeight="Medium"/>
                                </Grid>

                                <TextBlock Text="Sub-genres:" Opacity="0.7" Margin="0,0,0,8"/>
                                <ItemsControl ItemsSource="{Binding DetectedSubGenres}">
                                    <ItemsControl.ItemsPanel>
                                        <ItemsPanelTemplate>
                                            <WrapPanel/>
                                        </ItemsPanelTemplate>
                                    </ItemsControl.ItemsPanel>
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <materialDesign:Chip Content="{Binding}" Margin="0,0,8,8"/>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>

                                <Grid Margin="0,12,0,0">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="120"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Text="Target Audience:" Opacity="0.7"/>
                                    <TextBlock Grid.Column="1" Text="{Binding TargetAudience}" TextWrapping="Wrap"/>
                                </Grid>

                                <Grid Margin="0,12,0,0">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="120"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Text="Est. Word Count:" Opacity="0.7"/>
                                    <TextBlock Grid.Column="1" Text="{Binding EstimatedWordCount, StringFormat={}{0:N0} words}"/>
                                </Grid>
                            </StackPanel>
                        </materialDesign:Card>

                        <!-- Themes -->
                        <materialDesign:Card Padding="24" Margin="0,0,0,16">
                            <StackPanel>
                                <TextBlock Text="Extracted Themes"
                                           Style="{StaticResource MaterialDesignSubtitle1TextBlock}"
                                           Margin="0,0,0,16"/>
                                <ItemsControl ItemsSource="{Binding ExtractedThemes}">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Border Background="{DynamicResource MaterialDesignDivider}"
                                                    CornerRadius="4" Padding="12,8" Margin="0,0,0,8">
                                                <TextBlock Text="{Binding}"/>
                                            </Border>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </StackPanel>
                        </materialDesign:Card>

                        <!-- Core Conflict -->
                        <materialDesign:Card Padding="24">
                            <StackPanel>
                                <TextBlock Text="Core Conflict"
                                           Style="{StaticResource MaterialDesignSubtitle1TextBlock}"
                                           Margin="0,0,0,12"/>
                                <TextBlock Text="{Binding CoreConflict}" TextWrapping="Wrap"/>

                                <TextBlock Text="Tone" Margin="0,16,0,8"
                                           Style="{StaticResource MaterialDesignSubtitle2TextBlock}"/>
                                <TextBlock Text="{Binding Tone}" TextWrapping="Wrap" Opacity="0.9"/>
                            </StackPanel>
                        </materialDesign:Card>
                    </StackPanel>

                    <!-- Right Column -->
                    <StackPanel Grid.Column="2">
                        <!-- Characters -->
                        <materialDesign:Card Padding="24" Margin="0,0,0,16">
                            <StackPanel>
                                <TextBlock Text="Extracted Characters"
                                           Style="{StaticResource MaterialDesignSubtitle1TextBlock}"
                                           Margin="0,0,0,16"/>
                                <ItemsControl ItemsSource="{Binding ExtractedCharacters}">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Border Background="{DynamicResource MaterialDesignCardBackground}"
                                                    BorderBrush="{DynamicResource MaterialDesignDivider}"
                                                    BorderThickness="1" CornerRadius="8"
                                                    Padding="16" Margin="0,0,0,12">
                                                <Grid>
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="Auto"/>
                                                        <ColumnDefinition Width="*"/>
                                                    </Grid.ColumnDefinitions>

                                                    <Border Width="40" Height="40" CornerRadius="20"
                                                            Background="{DynamicResource PrimaryHueLightBrush}">
                                                        <materialDesign:PackIcon Kind="Person" 
                                                                                 Width="24" Height="24"
                                                                                 HorizontalAlignment="Center"
                                                                                 VerticalAlignment="Center"/>
                                                    </Border>

                                                    <StackPanel Grid.Column="1" Margin="12,0,0,0">
                                                        <TextBlock Text="{Binding Name}" FontWeight="Medium"/>
                                                        <TextBlock Text="{Binding Role}" 
                                                                   Style="{StaticResource MaterialDesignCaptionTextBlock}"
                                                                   Foreground="{DynamicResource PrimaryHueMidBrush}"/>
                                                        <TextBlock Text="{Binding Description}" 
                                                                   Style="{StaticResource MaterialDesignCaptionTextBlock}"
                                                                   Opacity="0.7" TextWrapping="Wrap" Margin="0,4,0,0"/>
                                                    </StackPanel>
                                                </Grid>
                                            </Border>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </StackPanel>
                        </materialDesign:Card>

                        <!-- Locations -->
                        <materialDesign:Card Padding="24">
                            <StackPanel>
                                <TextBlock Text="Extracted Locations"
                                           Style="{StaticResource MaterialDesignSubtitle1TextBlock}"
                                           Margin="0,0,0,16"/>
                                <ItemsControl ItemsSource="{Binding ExtractedLocations}">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Border Background="{DynamicResource MaterialDesignCardBackground}"
                                                    BorderBrush="{DynamicResource MaterialDesignDivider}"
                                                    BorderThickness="1" CornerRadius="8"
                                                    Padding="16" Margin="0,0,0,12">
                                                <Grid>
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="Auto"/>
                                                        <ColumnDefinition Width="*"/>
                                                    </Grid.ColumnDefinitions>

                                                    <Border Width="40" Height="40" CornerRadius="20"
                                                            Background="{DynamicResource SecondaryHueLightBrush}">
                                                        <materialDesign:PackIcon Kind="MapMarker" 
                                                                                 Width="24" Height="24"
                                                                                 HorizontalAlignment="Center"
                                                                                 VerticalAlignment="Center"/>
                                                    </Border>

                                                    <StackPanel Grid.Column="1" Margin="12,0,0,0">
                                                        <TextBlock Text="{Binding Name}" FontWeight="Medium"/>
                                                        <TextBlock Text="{Binding Type}" 
                                                                   Style="{StaticResource MaterialDesignCaptionTextBlock}"
                                                                   Foreground="{DynamicResource SecondaryHueMidBrush}"/>
                                                        <TextBlock Text="{Binding Significance}" 
                                                                   Style="{StaticResource MaterialDesignCaptionTextBlock}"
                                                                   Opacity="0.7" TextWrapping="Wrap" Margin="0,4,0,0"/>
                                                    </StackPanel>
                                                </Grid>
                                            </Border>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </StackPanel>
                        </materialDesign:Card>
                    </StackPanel>
                </Grid>

                <!-- Clarification Requests -->
                <materialDesign:Card Grid.Row="2" Padding="24" Margin="0,16,0,0"
                                     Visibility="{Binding HasClarifications, Converter={StaticResource BoolToVisibilityConverter}}">
                    <StackPanel>
                        <StackPanel Orientation="Horizontal" Margin="0,0,0,16">
                            <materialDesign:PackIcon Kind="HelpCircle" 
                                                     Width="24" Height="24"
                                                     Foreground="{DynamicResource SecondaryHueMidBrush}"
                                                     VerticalAlignment="Center"/>
                            <TextBlock Text="Clarifying Questions"
                                       Style="{StaticResource MaterialDesignSubtitle1TextBlock}"
                                       Margin="12,0,0,0" VerticalAlignment="Center"/>
                        </StackPanel>

                        <TextBlock Text="Help us understand your vision better by answering these questions:"
                                   Style="{StaticResource MaterialDesignBody2TextBlock}"
                                   Opacity="0.7" Margin="0,0,0,16"/>

                        <ItemsControl ItemsSource="{Binding ClarificationRequests}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Border Background="{DynamicResource MaterialDesignCardBackground}"
                                            BorderBrush="{DynamicResource MaterialDesignDivider}"
                                            BorderThickness="1" CornerRadius="8"
                                            Padding="20" Margin="0,0,0,16">
                                        <StackPanel>
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="*"/>
                                                    <ColumnDefinition Width="Auto"/>
                                                </Grid.ColumnDefinitions>

                                                <TextBlock Text="{Binding Question}" 
                                                           Style="{StaticResource MaterialDesignBody1TextBlock}"
                                                           TextWrapping="Wrap"/>
                                                <materialDesign:Chip Grid.Column="1" Content="{Binding Priority}"
                                                                     Margin="12,0,0,0"/>
                                            </Grid>

                                            <!-- Suggested Options -->
                                            <ItemsControl ItemsSource="{Binding SuggestedOptions}" 
                                                          Margin="0,12,0,0"
                                                          Visibility="{Binding SuggestedOptions.Count, Converter={StaticResource IntToVisibilityConverter}}">
                                                <ItemsControl.ItemsPanel>
                                                    <ItemsPanelTemplate>
                                                        <WrapPanel/>
                                                    </ItemsPanelTemplate>
                                                </ItemsControl.ItemsPanel>
                                                <ItemsControl.ItemTemplate>
                                                    <DataTemplate>
                                                        <RadioButton Content="{Binding}" 
                                                                     Style="{StaticResource MaterialDesignChoiceChipRadioButton}"
                                                                     Margin="0,0,8,8"
                                                                     GroupName="{Binding DataContext.Id, RelativeSource={RelativeSource AncestorType=Border}}"/>
                                                    </DataTemplate>
                                                </ItemsControl.ItemTemplate>
                                            </ItemsControl>

                                            <!-- Custom Response -->
                                            <TextBox Text="{Binding Response, UpdateSourceTrigger=PropertyChanged}"
                                                     Style="{StaticResource MaterialDesignOutlinedTextBox}"
                                                     Margin="0,12,0,0"
                                                     materialDesign:HintAssist.Hint="Or type your own answer..."/>
                                        </StackPanel>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </StackPanel>
                </materialDesign:Card>

                <!-- Enhancement Suggestions -->
                <materialDesign:Card Grid.Row="3" Padding="24" Margin="0,16,0,0"
                                     Visibility="{Binding HasEnhancements, Converter={StaticResource BoolToVisibilityConverter}}">
                    <StackPanel>
                        <StackPanel Orientation="Horizontal" Margin="0,0,0,16">
                            <materialDesign:PackIcon Kind="Lightbulb" 
                                                     Width="24" Height="24"
                                                     Foreground="{DynamicResource MaterialDesignBody}"
                                                     VerticalAlignment="Center"/>
                            <TextBlock Text="Suggestions to Enhance Your Story"
                                       Style="{StaticResource MaterialDesignSubtitle1TextBlock}"
                                       Margin="12,0,0,0" VerticalAlignment="Center"/>
                        </StackPanel>

                        <ItemsControl ItemsSource="{Binding EnhancementSuggestions}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Border Background="{DynamicResource MaterialDesignCardBackground}"
                                            BorderBrush="{DynamicResource MaterialDesignDivider}"
                                            BorderThickness="1" CornerRadius="8"
                                            Padding="16" Margin="0,0,0,12"
                                            Opacity="{Binding IsAccepted, Converter={StaticResource BoolToOpacityConverter}}">
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="Auto"/>
                                            </Grid.ColumnDefinitions>

                                            <StackPanel>
                                                <TextBlock Text="{Binding Category}" 
                                                           Style="{StaticResource MaterialDesignOverlineTextBlock}"
                                                           Foreground="{DynamicResource PrimaryHueMidBrush}"/>
                                                <TextBlock Text="{Binding Suggestion}" TextWrapping="Wrap"
                                                           Margin="0,4,0,0"/>
                                                <TextBlock Text="{Binding Impact}" 
                                                           Style="{StaticResource MaterialDesignCaptionTextBlock}"
                                                           Opacity="0.7" Margin="0,4,0,0"/>
                                            </StackPanel>

                                            <StackPanel Grid.Column="1" Orientation="Horizontal">
                                                <Button Style="{StaticResource MaterialDesignIconButton}"
                                                        Command="{Binding DataContext.AcceptSuggestionCommand, 
                                                            RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                        CommandParameter="{Binding}"
                                                        ToolTip="Accept">
                                                    <materialDesign:PackIcon Kind="Check"/>
                                                </Button>
                                                <Button Style="{StaticResource MaterialDesignIconButton}"
                                                        Command="{Binding DataContext.DismissSuggestionCommand, 
                                                            RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                        CommandParameter="{Binding}"
                                                        ToolTip="Dismiss">
                                                    <materialDesign:PackIcon Kind="Close"/>
                                                </Button>
                                            </StackPanel>
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </StackPanel>
                </materialDesign:Card>
            </Grid>
        </ScrollViewer>
    </Grid>
</UserControl>
