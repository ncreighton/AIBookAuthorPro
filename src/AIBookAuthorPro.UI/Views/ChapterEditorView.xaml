<UserControl
    x:Class="AIBookAuthorPro.UI.Views.ChapterEditorView"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
    xmlns:behaviors="clr-namespace:AIBookAuthorPro.UI.Behaviors"
    xmlns:converters="clr-namespace:AIBookAuthorPro.UI.Converters"
    xmlns:vm="clr-namespace:AIBookAuthorPro.UI.ViewModels"
    xmlns:i="http://schemas.microsoft.com/xaml/behaviors"
    mc:Ignorable="d"
    d:DataContext="{d:DesignInstance Type=vm:ChapterEditorViewModel}"
    d:DesignHeight="700"
    d:DesignWidth="1200">

    <UserControl.Resources>
        <converters:BoolToVisibilityConverter x:Key="BoolToVisibility" />
        <converters:BoolToVisibilityConverter x:Key="InverseBoolToVisibility" Invert="True" />
        <converters:WordCountDisplayConverter x:Key="WordCountDisplay" />
        <converters:ChapterStatusToColorConverter x:Key="StatusToColor" />

        <!-- Editor font style -->
        <Style x:Key="EditorTextStyle" TargetType="Paragraph">
            <Setter Property="FontFamily" Value="Georgia, Cambria, 'Times New Roman', serif" />
            <Setter Property="FontSize" Value="14" />
            <Setter Property="LineHeight" Value="24" />
            <Setter Property="Margin" Value="0,0,0,16" />
        </Style>
    </UserControl.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <!-- Toolbar -->
        <materialDesign:Card
            Grid.Row="0"
            Margin="0,0,0,8"
            Padding="8"
            materialDesign:ElevationAssist.Elevation="Dp1">

            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>

                <!-- Left: Title and Status -->
                <StackPanel
                    Grid.Column="0"
                    Orientation="Horizontal"
                    VerticalAlignment="Center">

                    <!-- Chapter Title -->
                    <TextBox
                        Text="{Binding Title, UpdateSourceTrigger=PropertyChanged}"
                        Style="{StaticResource MaterialDesignFloatingHintTextBox}"
                        materialDesign:HintAssist.Hint="Chapter Title"
                        MinWidth="250"
                        FontSize="16"
                        FontWeight="Medium"
                        Margin="0,0,16,0" />

                    <!-- Status Indicator -->
                    <ComboBox
                        ItemsSource="{Binding Source={x:Static vm:ChapterStatusOptions.All}}"
                        SelectedItem="{Binding Status}"
                        Style="{StaticResource MaterialDesignOutlinedComboBox}"
                        materialDesign:HintAssist.Hint="Status"
                        MinWidth="120"
                        Margin="0,0,16,0">
                        <ComboBox.ItemTemplate>
                            <DataTemplate>
                                <StackPanel Orientation="Horizontal">
                                    <Ellipse
                                        Width="10"
                                        Height="10"
                                        Fill="{Binding Converter={StaticResource StatusToColor}}"
                                        Margin="0,0,8,0" />
                                    <TextBlock Text="{Binding}" />
                                </StackPanel>
                            </DataTemplate>
                        </ComboBox.ItemTemplate>
                    </ComboBox>

                    <!-- Modified indicator -->
                    <materialDesign:PackIcon
                        Kind="ContentSaveEdit"
                        Foreground="{DynamicResource SecondaryHueMidBrush}"
                        ToolTip="Unsaved changes"
                        Visibility="{Binding IsModified, Converter={StaticResource BoolToVisibility}}"
                        VerticalAlignment="Center"
                        Width="20"
                        Height="20" />
                </StackPanel>

                <!-- Center: Formatting toolbar -->
                <StackPanel
                    Grid.Column="1"
                    Orientation="Horizontal"
                    HorizontalAlignment="Center">

                    <Button
                        Style="{StaticResource MaterialDesignIconButton}"
                        ToolTip="Bold (Ctrl+B)"
                        Command="EditingCommands.ToggleBold"
                        CommandTarget="{Binding ElementName=EditorRichTextBox}">
                        <materialDesign:PackIcon Kind="FormatBold" />
                    </Button>

                    <Button
                        Style="{StaticResource MaterialDesignIconButton}"
                        ToolTip="Italic (Ctrl+I)"
                        Command="EditingCommands.ToggleItalic"
                        CommandTarget="{Binding ElementName=EditorRichTextBox}">
                        <materialDesign:PackIcon Kind="FormatItalic" />
                    </Button>

                    <Button
                        Style="{StaticResource MaterialDesignIconButton}"
                        ToolTip="Underline (Ctrl+U)"
                        Command="EditingCommands.ToggleUnderline"
                        CommandTarget="{Binding ElementName=EditorRichTextBox}">
                        <materialDesign:PackIcon Kind="FormatUnderline" />
                    </Button>

                    <Separator Style="{StaticResource MaterialDesignLightSeparator}" Margin="8,4" />

                    <Button
                        Style="{StaticResource MaterialDesignIconButton}"
                        ToolTip="Insert Scene Break"
                        Command="{Binding InsertSceneBreakCommand}">
                        <materialDesign:PackIcon Kind="FormatPageBreak" />
                    </Button>

                    <Separator Style="{StaticResource MaterialDesignLightSeparator}" Margin="8,4" />

                    <Button
                        Style="{StaticResource MaterialDesignIconButton}"
                        ToolTip="Undo (Ctrl+Z)"
                        Command="{Binding UndoCommand}"
                        IsEnabled="{Binding CanUndo}">
                        <materialDesign:PackIcon Kind="Undo" />
                    </Button>

                    <Button
                        Style="{StaticResource MaterialDesignIconButton}"
                        ToolTip="Redo (Ctrl+Y)"
                        Command="{Binding RedoCommand}"
                        IsEnabled="{Binding CanRedo}">
                        <materialDesign:PackIcon Kind="Redo" />
                    </Button>
                </StackPanel>

                <!-- Right: Actions -->
                <StackPanel
                    Grid.Column="2"
                    Orientation="Horizontal">

                    <Button
                        Style="{StaticResource MaterialDesignIconButton}"
                        ToolTip="Copy to Clipboard"
                        Command="{Binding CopyToClipboardCommand}">
                        <materialDesign:PackIcon Kind="ContentCopy" />
                    </Button>

                    <Button
                        Style="{StaticResource MaterialDesignIconButton}"
                        ToolTip="Export to Markdown"
                        Command="{Binding ExportToMarkdownCommand}">
                        <materialDesign:PackIcon Kind="LanguageMarkdown" />
                    </Button>

                    <Separator Style="{StaticResource MaterialDesignLightSeparator}" Margin="8,4" />

                    <Button
                        Style="{StaticResource MaterialDesignFlatAccentButton}"
                        Content="SAVE"
                        Command="{Binding SaveChapterCommand}"
                        IsEnabled="{Binding IsModified}"
                        Margin="8,0,0,0" />
                </StackPanel>
            </Grid>
        </materialDesign:Card>

        <!-- Main Editor Area -->
        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" MinWidth="400" />
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="280" />
            </Grid.ColumnDefinitions>

            <!-- Editor -->
            <materialDesign:Card
                Grid.Column="0"
                Padding="0"
                materialDesign:ElevationAssist.Elevation="Dp2">

                <Grid>
                    <!-- Loading overlay -->
                    <Border
                        Background="{DynamicResource MaterialDesignPaper}"
                        Opacity="0.8"
                        Visibility="{Binding IsGenerating, Converter={StaticResource BoolToVisibility}}"
                        Panel.ZIndex="10">
                        <StackPanel
                            VerticalAlignment="Center"
                            HorizontalAlignment="Center">
                            <ProgressBar
                                Style="{StaticResource MaterialDesignCircularProgressBar}"
                                IsIndeterminate="True"
                                Width="48"
                                Height="48" />
                            <TextBlock
                                Text="Generating..."
                                Margin="0,16,0,0"
                                Style="{StaticResource MaterialDesignSubtitle1TextBlock}" />
                        </StackPanel>
                    </Border>

                    <!-- Rich Text Editor -->
                    <RichTextBox
                        x:Name="EditorRichTextBox"
                        AcceptsTab="True"
                        AcceptsReturn="True"
                        SpellCheck.IsEnabled="True"
                        VerticalScrollBarVisibility="Auto"
                        Padding="48,32"
                        BorderThickness="0"
                        FontFamily="Georgia, Cambria, 'Times New Roman', serif"
                        FontSize="14"
                        IsEnabled="{Binding IsGenerating, Converter={StaticResource InverseBoolToVisibility}}">
                        <i:Interaction.Behaviors>
                            <behaviors:RichTextBoxBindingBehavior
                                XamlContent="{Binding Content, Mode=TwoWay}"
                                FlowDocumentService="{Binding FlowDocumentService}"
                                DebounceDelay="500" />
                        </i:Interaction.Behaviors>
                    </RichTextBox>
                </Grid>
            </materialDesign:Card>

            <!-- Splitter -->
            <GridSplitter
                Grid.Column="1"
                Width="8"
                HorizontalAlignment="Center"
                VerticalAlignment="Stretch"
                Background="Transparent" />

            <!-- Side Panel -->
            <materialDesign:Card
                Grid.Column="2"
                Padding="16"
                materialDesign:ElevationAssist.Elevation="Dp1">

                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <StackPanel>
                        <!-- Chapter Info -->
                        <TextBlock
                            Text="CHAPTER INFO"
                            Style="{StaticResource MaterialDesignOverlineTextBlock}"
                            Foreground="{DynamicResource MaterialDesignBodyLight}"
                            Margin="0,0,0,8" />

                        <!-- Word Count Progress -->
                        <StackPanel Margin="0,0,0,16">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="Auto" />
                                </Grid.ColumnDefinitions>

                                <TextBlock
                                    Text="Word Count"
                                    Style="{StaticResource MaterialDesignCaptionTextBlock}" />

                                <TextBlock
                                    Grid.Column="1"
                                    Style="{StaticResource MaterialDesignCaptionTextBlock}">
                                    <TextBlock.Text>
                                        <MultiBinding Converter="{StaticResource WordCountDisplay}">
                                            <Binding Path="WordCount" />
                                            <Binding Path="TargetWordCount" />
                                        </MultiBinding>
                                    </TextBlock.Text>
                                </TextBlock>
                            </Grid>

                            <ProgressBar
                                Value="{Binding CompletionPercentage}"
                                Maximum="100"
                                Height="8"
                                Margin="0,4,0,0"
                                Style="{StaticResource MaterialDesignLinearProgressBar}" />
                        </StackPanel>

                        <!-- Target Word Count -->
                        <TextBox
                            Text="{Binding TargetWordCount, UpdateSourceTrigger=PropertyChanged}"
                            Style="{StaticResource MaterialDesignOutlinedTextBox}"
                            materialDesign:HintAssist.Hint="Target Words"
                            Margin="0,0,0,16" />

                        <Separator Margin="0,0,0,16" />

                        <!-- Outline -->
                        <TextBlock
                            Text="OUTLINE"
                            Style="{StaticResource MaterialDesignOverlineTextBlock}"
                            Foreground="{DynamicResource MaterialDesignBodyLight}"
                            Margin="0,0,0,8" />

                        <TextBox
                            Text="{Binding Outline, UpdateSourceTrigger=PropertyChanged}"
                            Style="{StaticResource MaterialDesignOutlinedTextBox}"
                            materialDesign:HintAssist.Hint="Chapter outline..."
                            TextWrapping="Wrap"
                            AcceptsReturn="True"
                            MinHeight="100"
                            MaxHeight="150"
                            VerticalScrollBarVisibility="Auto"
                            Margin="0,0,0,16" />

                        <!-- Summary -->
                        <TextBlock
                            Text="SUMMARY"
                            Style="{StaticResource MaterialDesignOverlineTextBlock}"
                            Foreground="{DynamicResource MaterialDesignBodyLight}"
                            Margin="0,0,0,8" />

                        <TextBox
                            Text="{Binding Summary, UpdateSourceTrigger=PropertyChanged}"
                            Style="{StaticResource MaterialDesignOutlinedTextBox}"
                            materialDesign:HintAssist.Hint="Chapter summary..."
                            TextWrapping="Wrap"
                            AcceptsReturn="True"
                            MinHeight="80"
                            MaxHeight="120"
                            VerticalScrollBarVisibility="Auto"
                            Margin="0,0,0,16" />

                        <!-- Notes -->
                        <TextBlock
                            Text="NOTES"
                            Style="{StaticResource MaterialDesignOverlineTextBlock}"
                            Foreground="{DynamicResource MaterialDesignBodyLight}"
                            Margin="0,0,0,8" />

                        <TextBox
                            Text="{Binding Notes, UpdateSourceTrigger=PropertyChanged}"
                            Style="{StaticResource MaterialDesignOutlinedTextBox}"
                            materialDesign:HintAssist.Hint="Your notes..."
                            TextWrapping="Wrap"
                            AcceptsReturn="True"
                            MinHeight="80"
                            MaxHeight="120"
                            VerticalScrollBarVisibility="Auto" />
                    </StackPanel>
                </ScrollViewer>
            </materialDesign:Card>
        </Grid>

        <!-- Status Bar -->
        <materialDesign:Card
            Grid.Row="2"
            Margin="0,8,0,0"
            Padding="12,8"
            materialDesign:ElevationAssist.Elevation="Dp1">

            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>

                <!-- Status Message -->
                <TextBlock
                    Grid.Column="0"
                    Text="{Binding StatusMessage}"
                    Style="{StaticResource MaterialDesignCaptionTextBlock}"
                    VerticalAlignment="Center" />

                <!-- Word Count -->
                <StackPanel
                    Grid.Column="1"
                    Orientation="Horizontal"
                    Margin="16,0">
                    <materialDesign:PackIcon
                        Kind="FormatText"
                        VerticalAlignment="Center"
                        Margin="0,0,4,0" />
                    <TextBlock
                        VerticalAlignment="Center"
                        Style="{StaticResource MaterialDesignCaptionTextBlock}">
                        <TextBlock.Text>
                            <MultiBinding Converter="{StaticResource WordCountDisplay}">
                                <Binding Path="WordCount" />
                                <Binding Path="TargetWordCount" />
                            </MultiBinding>
                        </TextBlock.Text>
                    </TextBlock>
                </StackPanel>

                <!-- Saving indicator -->
                <StackPanel
                    Grid.Column="2"
                    Orientation="Horizontal"
                    Visibility="{Binding IsSaving, Converter={StaticResource BoolToVisibility}}">
                    <ProgressBar
                        Style="{StaticResource MaterialDesignCircularProgressBar}"
                        IsIndeterminate="True"
                        Width="16"
                        Height="16"
                        Margin="0,0,8,0" />
                    <TextBlock
                        Text="Saving..."
                        Style="{StaticResource MaterialDesignCaptionTextBlock}"
                        VerticalAlignment="Center" />
                </StackPanel>

                <!-- Status -->
                <StackPanel
                    Grid.Column="3"
                    Orientation="Horizontal"
                    Margin="16,0,0,0">
                    <Ellipse
                        Width="8"
                        Height="8"
                        Fill="{Binding Status, Converter={StaticResource StatusToColor}}"
                        Margin="0,0,6,0"
                        VerticalAlignment="Center" />
                    <TextBlock
                        Text="{Binding Status}"
                        Style="{StaticResource MaterialDesignCaptionTextBlock}"
                        VerticalAlignment="Center" />
                </StackPanel>
            </Grid>
        </materialDesign:Card>
    </Grid>
</UserControl>
