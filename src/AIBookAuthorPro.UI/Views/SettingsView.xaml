<UserControl
    x:Class="AIBookAuthorPro.UI.Views.SettingsView"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
    xmlns:converters="clr-namespace:AIBookAuthorPro.UI.Converters"
    xmlns:vm="clr-namespace:AIBookAuthorPro.UI.ViewModels"
    mc:Ignorable="d"
    d:DataContext="{d:DesignInstance Type=vm:SettingsViewModel}"
    d:DesignHeight="700"
    d:DesignWidth="900">

    <UserControl.Resources>
        <converters:BoolToVisibilityConverter x:Key="BoolToVisibility" />
    </UserControl.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <!-- Header -->
        <Border
            Grid.Row="0"
            Background="{DynamicResource PrimaryHueMidBrush}"
            Padding="24,16">

            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>

                <StackPanel>
                    <TextBlock
                        Text="Settings"
                        Style="{StaticResource MaterialDesignHeadline5TextBlock}"
                        Foreground="{DynamicResource PrimaryHueMidForegroundBrush}" />
                    <TextBlock
                        Text="Configure your AI Book Author Pro preferences"
                        Style="{StaticResource MaterialDesignSubtitle1TextBlock}"
                        Foreground="{DynamicResource PrimaryHueMidForegroundBrush}"
                        Opacity="0.8" />
                </StackPanel>

                <Button
                    Grid.Column="1"
                    Style="{StaticResource MaterialDesignIconForegroundButton}"
                    Command="{Binding CancelCommand}"
                    Foreground="{DynamicResource PrimaryHueMidForegroundBrush}">
                    <materialDesign:PackIcon Kind="Close" Width="24" Height="24" />
                </Button>
            </Grid>
        </Border>

        <!-- Tab Content -->
        <TabControl
            Grid.Row="1"
            SelectedIndex="{Binding SelectedTabIndex}"
            Style="{StaticResource MaterialDesignNavigationRailTabControl}"
            materialDesign:ColorZoneAssist.Mode="PrimaryMid">

            <!-- API Keys Tab -->
            <TabItem>
                <TabItem.Header>
                    <StackPanel>
                        <materialDesign:PackIcon Kind="Key" Width="24" Height="24" HorizontalAlignment="Center" />
                        <TextBlock Text="API Keys" />
                    </StackPanel>
                </TabItem.Header>

                <ScrollViewer Padding="24" VerticalScrollBarVisibility="Auto">
                    <StackPanel MaxWidth="600">
                        <TextBlock
                            Text="AI Provider API Keys"
                            Style="{StaticResource MaterialDesignHeadline6TextBlock}"
                            Margin="0,0,0,8" />
                        <TextBlock
                            Text="Enter your API keys to enable AI generation. Keys are stored securely using Windows Data Protection."
                            Style="{StaticResource MaterialDesignBody2TextBlock}"
                            Foreground="{DynamicResource MaterialDesignBodyLight}"
                            TextWrapping="Wrap"
                            Margin="0,0,0,24" />

                        <!-- Anthropic -->
                        <materialDesign:Card Padding="16" Margin="0,0,0,16">
                            <StackPanel>
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*" />
                                        <ColumnDefinition Width="Auto" />
                                    </Grid.ColumnDefinitions>

                                    <StackPanel>
                                        <StackPanel Orientation="Horizontal">
                                            <TextBlock
                                                Text="Anthropic (Claude)"
                                                Style="{StaticResource MaterialDesignSubtitle1TextBlock}" />
                                            <materialDesign:PackIcon
                                                Kind="CheckCircle"
                                                Foreground="Green"
                                                Margin="8,0,0,0"
                                                VerticalAlignment="Center"
                                                Visibility="{Binding AnthropicConfigured, Converter={StaticResource BoolToVisibility}}" />
                                        </StackPanel>
                                        <TextBlock
                                            Text="claude.ai - Best for creative writing"
                                            Style="{StaticResource MaterialDesignCaptionTextBlock}"
                                            Foreground="{DynamicResource MaterialDesignBodyLight}" />
                                    </StackPanel>

                                    <Button
                                        Grid.Column="1"
                                        Style="{StaticResource MaterialDesignOutlinedButton}"
                                        Content="Test"
                                        Command="{Binding TestApiKeyCommand}"
                                        CommandParameter="anthropic" />
                                </Grid>

                                <TextBox
                                    Text="{Binding AnthropicApiKey, UpdateSourceTrigger=PropertyChanged}"
                                    Style="{StaticResource MaterialDesignOutlinedTextBox}"
                                    materialDesign:HintAssist.Hint="API Key (sk-ant-...)"
                                    Margin="0,12,0,0" />

                                <TextBlock
                                    Text="{Binding TestResult}"
                                    Style="{StaticResource MaterialDesignCaptionTextBlock}"
                                    Margin="0,8,0,0"
                                    Visibility="{Binding TestingProvider, Converter={StaticResource BoolToVisibility}}" />
                            </StackPanel>
                        </materialDesign:Card>

                        <!-- OpenAI -->
                        <materialDesign:Card Padding="16" Margin="0,0,0,16">
                            <StackPanel>
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*" />
                                        <ColumnDefinition Width="Auto" />
                                    </Grid.ColumnDefinitions>

                                    <StackPanel>
                                        <StackPanel Orientation="Horizontal">
                                            <TextBlock
                                                Text="OpenAI"
                                                Style="{StaticResource MaterialDesignSubtitle1TextBlock}" />
                                            <materialDesign:PackIcon
                                                Kind="CheckCircle"
                                                Foreground="Green"
                                                Margin="8,0,0,0"
                                                VerticalAlignment="Center"
                                                Visibility="{Binding OpenAIConfigured, Converter={StaticResource BoolToVisibility}}" />
                                        </StackPanel>
                                        <TextBlock
                                            Text="GPT-4o and o1 models"
                                            Style="{StaticResource MaterialDesignCaptionTextBlock}"
                                            Foreground="{DynamicResource MaterialDesignBodyLight}" />
                                    </StackPanel>

                                    <Button
                                        Grid.Column="1"
                                        Style="{StaticResource MaterialDesignOutlinedButton}"
                                        Content="Test"
                                        Command="{Binding TestApiKeyCommand}"
                                        CommandParameter="openai" />
                                </Grid>

                                <TextBox
                                    Text="{Binding OpenAIApiKey, UpdateSourceTrigger=PropertyChanged}"
                                    Style="{StaticResource MaterialDesignOutlinedTextBox}"
                                    materialDesign:HintAssist.Hint="API Key (sk-...)"
                                    Margin="0,12,0,0" />
                            </StackPanel>
                        </materialDesign:Card>

                        <!-- Gemini -->
                        <materialDesign:Card Padding="16">
                            <StackPanel>
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*" />
                                        <ColumnDefinition Width="Auto" />
                                    </Grid.ColumnDefinitions>

                                    <StackPanel>
                                        <StackPanel Orientation="Horizontal">
                                            <TextBlock
                                                Text="Google Gemini"
                                                Style="{StaticResource MaterialDesignSubtitle1TextBlock}" />
                                            <materialDesign:PackIcon
                                                Kind="CheckCircle"
                                                Foreground="Green"
                                                Margin="8,0,0,0"
                                                VerticalAlignment="Center"
                                                Visibility="{Binding GeminiConfigured, Converter={StaticResource BoolToVisibility}}" />
                                        </StackPanel>
                                        <TextBlock
                                            Text="Gemini Pro and Flash models"
                                            Style="{StaticResource MaterialDesignCaptionTextBlock}"
                                            Foreground="{DynamicResource MaterialDesignBodyLight}" />
                                    </StackPanel>

                                    <Button
                                        Grid.Column="1"
                                        Style="{StaticResource MaterialDesignOutlinedButton}"
                                        Content="Test"
                                        Command="{Binding TestApiKeyCommand}"
                                        CommandParameter="gemini" />
                                </Grid>

                                <TextBox
                                    Text="{Binding GeminiApiKey, UpdateSourceTrigger=PropertyChanged}"
                                    Style="{StaticResource MaterialDesignOutlinedTextBox}"
                                    materialDesign:HintAssist.Hint="API Key"
                                    Margin="0,12,0,0" />
                            </StackPanel>
                        </materialDesign:Card>
                    </StackPanel>
                </ScrollViewer>
            </TabItem>

            <!-- Generation Tab -->
            <TabItem>
                <TabItem.Header>
                    <StackPanel>
                        <materialDesign:PackIcon Kind="Creation" Width="24" Height="24" HorizontalAlignment="Center" />
                        <TextBlock Text="Generation" />
                    </StackPanel>
                </TabItem.Header>

                <ScrollViewer Padding="24" VerticalScrollBarVisibility="Auto">
                    <StackPanel MaxWidth="600">
                        <TextBlock
                            Text="Default Generation Settings"
                            Style="{StaticResource MaterialDesignHeadline6TextBlock}"
                            Margin="0,0,0,24" />

                        <ComboBox
                            ItemsSource="{Binding AvailableProviders}"
                            SelectedItem="{Binding DefaultProvider}"
                            Style="{StaticResource MaterialDesignOutlinedComboBox}"
                            materialDesign:HintAssist.Hint="Default AI Provider"
                            Margin="0,0,0,16" />

                        <ComboBox
                            ItemsSource="{Binding AvailableModes}"
                            SelectedItem="{Binding DefaultMode}"
                            Style="{StaticResource MaterialDesignOutlinedComboBox}"
                            materialDesign:HintAssist.Hint="Default Generation Mode"
                            Margin="0,0,0,16" />

                        <StackPanel Margin="0,0,0,16">
                            <TextBlock
                                Text="Default Temperature (Creativity)"
                                Style="{StaticResource MaterialDesignCaptionTextBlock}"
                                Margin="0,0,0,8" />
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="50" />
                                </Grid.ColumnDefinitions>
                                <Slider
                                    Value="{Binding DefaultTemperature}"
                                    Minimum="0"
                                    Maximum="1"
                                    TickFrequency="0.1"
                                    IsSnapToTickEnabled="True" />
                                <TextBlock
                                    Grid.Column="1"
                                    Text="{Binding DefaultTemperature, StringFormat='{}{0:F1}'}"
                                    VerticalAlignment="Center"
                                    HorizontalAlignment="Right" />
                            </Grid>
                        </StackPanel>

                        <TextBox
                            Text="{Binding DefaultChapterWordCount}"
                            Style="{StaticResource MaterialDesignOutlinedTextBox}"
                            materialDesign:HintAssist.Hint="Default Chapter Word Count"
                            Margin="0,0,0,16" />

                        <TextBlock
                            Text="Default Context Options"
                            Style="{StaticResource MaterialDesignSubtitle1TextBlock}"
                            Margin="0,16,0,8" />

                        <CheckBox
                            Content="Include character context"
                            IsChecked="{Binding IncludeCharacterContext}"
                            Margin="0,0,0,8" />

                        <CheckBox
                            Content="Include location context"
                            IsChecked="{Binding IncludeLocationContext}"
                            Margin="0,0,0,8" />

                        <CheckBox
                            Content="Include previous chapter summary"
                            IsChecked="{Binding IncludePreviousSummary}" />
                    </StackPanel>
                </ScrollViewer>
            </TabItem>

            <!-- Editor Tab -->
            <TabItem>
                <TabItem.Header>
                    <StackPanel>
                        <materialDesign:PackIcon Kind="Pencil" Width="24" Height="24" HorizontalAlignment="Center" />
                        <TextBlock Text="Editor" />
                    </StackPanel>
                </TabItem.Header>

                <ScrollViewer Padding="24" VerticalScrollBarVisibility="Auto">
                    <StackPanel MaxWidth="600">
                        <TextBlock
                            Text="Editor Preferences"
                            Style="{StaticResource MaterialDesignHeadline6TextBlock}"
                            Margin="0,0,0,24" />

                        <ComboBox
                            ItemsSource="{Binding AvailableFonts}"
                            SelectedItem="{Binding FontFamily}"
                            Style="{StaticResource MaterialDesignOutlinedComboBox}"
                            materialDesign:HintAssist.Hint="Font Family"
                            Margin="0,0,0,16" />

                        <Grid Margin="0,0,0,16">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="*" />
                            </Grid.ColumnDefinitions>

                            <TextBox
                                Text="{Binding FontSize}"
                                Style="{StaticResource MaterialDesignOutlinedTextBox}"
                                materialDesign:HintAssist.Hint="Font Size"
                                Margin="0,0,8,0" />

                            <TextBox
                                Grid.Column="1"
                                Text="{Binding LineHeight}"
                                Style="{StaticResource MaterialDesignOutlinedTextBox}"
                                materialDesign:HintAssist.Hint="Line Height"
                                Margin="8,0,0,0" />
                        </Grid>

                        <Grid Margin="0,0,0,16">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="*" />
                            </Grid.ColumnDefinitions>

                            <TextBox
                                Text="{Binding AutoSaveInterval}"
                                Style="{StaticResource MaterialDesignOutlinedTextBox}"
                                materialDesign:HintAssist.Hint="Auto-save (seconds, 0=off)"
                                Margin="0,0,8,0" />

                            <TextBox
                                Grid.Column="1"
                                Text="{Binding MaxUndoHistory}"
                                Style="{StaticResource MaterialDesignOutlinedTextBox}"
                                materialDesign:HintAssist.Hint="Max Undo History"
                                Margin="8,0,0,0" />
                        </Grid>

                        <CheckBox
                            Content="Enable spell check"
                            IsChecked="{Binding SpellCheckEnabled}"
                            Margin="0,0,0,8" />

                        <CheckBox
                            Content="Show word count in status bar"
                            IsChecked="{Binding ShowWordCount}"
                            Margin="0,0,0,8" />

                        <CheckBox
                            Content="Show estimated reading time"
                            IsChecked="{Binding ShowReadingTime}" />
                    </StackPanel>
                </ScrollViewer>
            </TabItem>

            <!-- Export Tab -->
            <TabItem>
                <TabItem.Header>
                    <StackPanel>
                        <materialDesign:PackIcon Kind="Export" Width="24" Height="24" HorizontalAlignment="Center" />
                        <TextBlock Text="Export" />
                    </StackPanel>
                </TabItem.Header>

                <ScrollViewer Padding="24" VerticalScrollBarVisibility="Auto">
                    <StackPanel MaxWidth="600">
                        <TextBlock
                            Text="Export Defaults"
                            Style="{StaticResource MaterialDesignHeadline6TextBlock}"
                            Margin="0,0,0,24" />

                        <ComboBox
                            ItemsSource="{Binding AvailableExportFormats}"
                            SelectedItem="{Binding DefaultExportFormat}"
                            Style="{StaticResource MaterialDesignOutlinedComboBox}"
                            materialDesign:HintAssist.Hint="Default Export Format"
                            Margin="0,0,0,16" />

                        <Grid Margin="0,0,0,16">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>

                            <TextBox
                                Text="{Binding DefaultOutputDirectory}"
                                Style="{StaticResource MaterialDesignOutlinedTextBox}"
                                materialDesign:HintAssist.Hint="Default Output Directory"
                                IsReadOnly="True" />

                            <Button
                                Grid.Column="1"
                                Style="{StaticResource MaterialDesignIconButton}"
                                Command="{Binding BrowseOutputDirectoryCommand}"
                                Margin="8,0,0,0">
                                <materialDesign:PackIcon Kind="FolderOpen" />
                            </Button>
                        </Grid>

                        <CheckBox
                            Content="Include table of contents"
                            IsChecked="{Binding IncludeTableOfContents}"
                            Margin="0,0,0,8" />

                        <CheckBox
                            Content="Include chapter titles"
                            IsChecked="{Binding IncludeChapterTitles}"
                            Margin="0,0,0,8" />

                        <CheckBox
                            Content="Start each chapter on new page"
                            IsChecked="{Binding ChapterPageBreaks}"
                            Margin="0,0,0,8" />

                        <CheckBox
                            Content="Embed fonts in document"
                            IsChecked="{Binding EmbedFonts}" />
                    </StackPanel>
                </ScrollViewer>
            </TabItem>

            <!-- Appearance Tab -->
            <TabItem>
                <TabItem.Header>
                    <StackPanel>
                        <materialDesign:PackIcon Kind="Palette" Width="24" Height="24" HorizontalAlignment="Center" />
                        <TextBlock Text="Appearance" />
                    </StackPanel>
                </TabItem.Header>

                <ScrollViewer Padding="24" VerticalScrollBarVisibility="Auto">
                    <StackPanel MaxWidth="600">
                        <TextBlock
                            Text="Theme &amp; Colors"
                            Style="{StaticResource MaterialDesignHeadline6TextBlock}"
                            Margin="0,0,0,24" />

                        <ComboBox
                            ItemsSource="{Binding AvailableThemes}"
                            SelectedItem="{Binding Theme}"
                            Style="{StaticResource MaterialDesignOutlinedComboBox}"
                            materialDesign:HintAssist.Hint="Theme"
                            Margin="0,0,0,16" />

                        <ComboBox
                            ItemsSource="{Binding AvailableColors}"
                            SelectedItem="{Binding PrimaryColor}"
                            Style="{StaticResource MaterialDesignOutlinedComboBox}"
                            materialDesign:HintAssist.Hint="Primary Color"
                            Margin="0,0,0,16" />

                        <ComboBox
                            ItemsSource="{Binding AvailableColors}"
                            SelectedItem="{Binding AccentColor}"
                            Style="{StaticResource MaterialDesignOutlinedComboBox}"
                            materialDesign:HintAssist.Hint="Accent Color"
                            Margin="0,0,0,16" />

                        <CheckBox
                            Content="Compact mode (reduced spacing)"
                            IsChecked="{Binding CompactMode}" />
                    </StackPanel>
                </ScrollViewer>
            </TabItem>
        </TabControl>

        <!-- Footer -->
        <Border
            Grid.Row="2"
            Background="{DynamicResource MaterialDesignCardBackground}"
            Padding="24,16"
            BorderThickness="0,1,0,0"
            BorderBrush="{DynamicResource MaterialDesignDivider}">

            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>

                <Button
                    Style="{StaticResource MaterialDesignOutlinedButton}"
                    Content="Reset to Defaults"
                    Command="{Binding ResetToDefaultsCommand}" />

                <TextBlock
                    Grid.Column="1"
                    Text="{Binding StatusMessage}"
                    VerticalAlignment="Center"
                    HorizontalAlignment="Center"
                    Style="{StaticResource MaterialDesignCaptionTextBlock}" />

                <StackPanel
                    Grid.Column="2"
                    Orientation="Horizontal">

                    <Button
                        Style="{StaticResource MaterialDesignFlatButton}"
                        Content="Cancel"
                        Command="{Binding CancelCommand}"
                        Margin="0,0,8,0" />

                    <Button
                        Style="{StaticResource MaterialDesignRaisedButton}"
                        Content="Save"
                        Command="{Binding SaveSettingsCommand}"
                        IsEnabled="{Binding HasChanges}" />
                </StackPanel>
            </Grid>
        </Border>
    </Grid>
</UserControl>
