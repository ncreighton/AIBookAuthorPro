<UserControl
    x:Class="AIBookAuthorPro.UI.Views.OutlineEditorView"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
    xmlns:converters="clr-namespace:AIBookAuthorPro.UI.Converters"
    xmlns:vm="clr-namespace:AIBookAuthorPro.UI.ViewModels"
    mc:Ignorable="d"
    d:DataContext="{d:DesignInstance Type=vm:OutlineEditorViewModel}"
    d:DesignHeight="700"
    d:DesignWidth="1200">

    <UserControl.Resources>
        <converters:BoolToVisibilityConverter x:Key="BoolToVisibility" />
        <converters:BoolToVisibilityConverter x:Key="InvertedBoolToVisibility" Invert="True" />
        
        <!-- TreeView Item Style -->
        <Style x:Key="OutlineTreeItemStyle" TargetType="TreeViewItem" BasedOn="{StaticResource MaterialDesignTreeViewItem}">
            <Setter Property="IsExpanded" Value="{Binding IsExpanded, Mode=TwoWay}" />
            <Setter Property="IsSelected" Value="{Binding IsSelected, Mode=TwoWay}" />
            <Setter Property="Padding" Value="4" />
        </Style>
    </UserControl.Resources>

    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*" MinWidth="300" />
            <ColumnDefinition Width="Auto" />
            <ColumnDefinition Width="350" />
        </Grid.ColumnDefinitions>

        <!-- Left Panel: Outline Tree -->
        <Grid Grid.Column="0">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="*" />
            </Grid.RowDefinitions>

            <!-- Header -->
            <materialDesign:Card
                Grid.Row="0"
                Margin="16,16,8,8"
                Padding="16">

                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>

                    <Button
                        Style="{StaticResource MaterialDesignIconButton}"
                        Command="{Binding GoBackCommand}"
                        ToolTip="Back">
                        <materialDesign:PackIcon Kind="ArrowLeft" />
                    </Button>

                    <StackPanel Grid.Column="1" Margin="16,0">
                        <TextBlock
                            Text="Outline Editor"
                            Style="{StaticResource MaterialDesignHeadline6TextBlock}" />
                        <TextBlock
                            Text="{Binding StatusMessage}"
                            Style="{StaticResource MaterialDesignCaptionTextBlock}"
                            Foreground="{DynamicResource MaterialDesignBodyLight}" />
                    </StackPanel>

                    <StackPanel Grid.Column="2" Orientation="Horizontal">
                        <Button
                            Style="{StaticResource MaterialDesignOutlinedButton}"
                            Command="{Binding GenerateOutlineCommand}"
                            IsEnabled="{Binding IsGenerating, Converter={StaticResource InvertedBoolConverter}}"
                            Margin="0,0,8,0">
                            <StackPanel Orientation="Horizontal">
                                <materialDesign:PackIcon Kind="AutoFix" Margin="0,0,8,0" />
                                <TextBlock Text="AI Generate" />
                            </StackPanel>
                        </Button>

                        <Button
                            Style="{StaticResource MaterialDesignRaisedButton}"
                            Command="{Binding SaveCommand}">
                            <StackPanel Orientation="Horizontal">
                                <materialDesign:PackIcon Kind="ContentSave" Margin="0,0,8,0" />
                                <TextBlock Text="Save" />
                            </StackPanel>
                        </Button>
                    </StackPanel>
                </Grid>
            </materialDesign:Card>

            <!-- Toolbar -->
            <materialDesign:Card
                Grid.Row="1"
                Margin="16,0,8,8"
                Padding="8">

                <StackPanel Orientation="Horizontal">
                    <!-- Add Items Menu -->
                    <materialDesign:PopupBox
                        PlacementMode="BottomAndAlignLeftEdges"
                        StaysOpen="False">
                        <materialDesign:PopupBox.ToggleContent>
                            <Button Style="{StaticResource MaterialDesignFlatButton}">
                                <StackPanel Orientation="Horizontal">
                                    <materialDesign:PackIcon Kind="Plus" Margin="0,0,8,0" />
                                    <TextBlock Text="Add" />
                                </StackPanel>
                            </Button>
                        </materialDesign:PopupBox.ToggleContent>
                        <StackPanel MinWidth="150">
                            <Button Content="Act" Command="{Binding AddItemCommand}" CommandParameter="Act" />
                            <Button Content="Part" Command="{Binding AddItemCommand}" CommandParameter="Part" />
                            <Button Content="Chapter" Command="{Binding AddItemCommand}" CommandParameter="Chapter" />
                            <Button Content="Scene" Command="{Binding AddItemCommand}" CommandParameter="Scene" />
                            <Button Content="Beat" Command="{Binding AddItemCommand}" CommandParameter="Beat" />
                            <Button Content="Note" Command="{Binding AddItemCommand}" CommandParameter="Note" />
                        </StackPanel>
                    </materialDesign:PopupBox>

                    <Separator Style="{StaticResource MaterialDesignSeparator}" />

                    <Button
                        Style="{StaticResource MaterialDesignIconButton}"
                        Command="{Binding MoveUpCommand}"
                        CommandParameter="{Binding SelectedItem}"
                        ToolTip="Move Up">
                        <materialDesign:PackIcon Kind="ArrowUp" />
                    </Button>

                    <Button
                        Style="{StaticResource MaterialDesignIconButton}"
                        Command="{Binding MoveDownCommand}"
                        CommandParameter="{Binding SelectedItem}"
                        ToolTip="Move Down">
                        <materialDesign:PackIcon Kind="ArrowDown" />
                    </Button>

                    <Button
                        Style="{StaticResource MaterialDesignIconButton}"
                        Command="{Binding IndentCommand}"
                        CommandParameter="{Binding SelectedItem}"
                        ToolTip="Indent (make child)">
                        <materialDesign:PackIcon Kind="FormatIndentIncrease" />
                    </Button>

                    <Button
                        Style="{StaticResource MaterialDesignIconButton}"
                        Command="{Binding OutdentCommand}"
                        CommandParameter="{Binding SelectedItem}"
                        ToolTip="Outdent (move to parent level)">
                        <materialDesign:PackIcon Kind="FormatIndentDecrease" />
                    </Button>

                    <Separator Style="{StaticResource MaterialDesignSeparator}" />

                    <Button
                        Style="{StaticResource MaterialDesignIconButton}"
                        Command="{Binding ExpandAllCommand}"
                        ToolTip="Expand All">
                        <materialDesign:PackIcon Kind="UnfoldMoreHorizontal" />
                    </Button>

                    <Button
                        Style="{StaticResource MaterialDesignIconButton}"
                        Command="{Binding CollapseAllCommand}"
                        ToolTip="Collapse All">
                        <materialDesign:PackIcon Kind="UnfoldLessHorizontal" />
                    </Button>

                    <Separator Style="{StaticResource MaterialDesignSeparator}" />

                    <Button
                        Style="{StaticResource MaterialDesignIconButton}"
                        Command="{Binding DeleteItemCommand}"
                        CommandParameter="{Binding SelectedItem}"
                        Foreground="{DynamicResource MaterialDesignValidationErrorBrush}"
                        ToolTip="Delete">
                        <materialDesign:PackIcon Kind="Delete" />
                    </Button>
                </StackPanel>
            </materialDesign:Card>

            <!-- Outline Tree -->
            <TreeView
                Grid.Row="2"
                Margin="16,0,8,16"
                ItemsSource="{Binding OutlineItems}"
                ItemContainerStyle="{StaticResource OutlineTreeItemStyle}"
                SelectedItemChanged="TreeView_SelectedItemChanged"
                VirtualizingStackPanel.IsVirtualizing="True"
                VirtualizingStackPanel.VirtualizationMode="Recycling">

                <TreeView.ItemTemplate>
                    <HierarchicalDataTemplate ItemsSource="{Binding Children}">
                        <StackPanel Orientation="Horizontal" Margin="4">
                            <materialDesign:PackIcon
                                Kind="{Binding Icon}"
                                Width="20"
                                Height="20"
                                Margin="0,0,8,0"
                                VerticalAlignment="Center" />
                            
                            <TextBlock
                                Text="{Binding Title}"
                                Style="{StaticResource MaterialDesignBody1TextBlock}"
                                VerticalAlignment="Center" />

                            <materialDesign:PackIcon
                                Kind="Link"
                                Width="16"
                                Height="16"
                                Margin="8,0,0,0"
                                VerticalAlignment="Center"
                                Foreground="{DynamicResource PrimaryHueMidBrush}"
                                ToolTip="Linked to chapter"
                                Visibility="{Binding HasLinkedChapter, Converter={StaticResource BoolToVisibility}}" />
                        </StackPanel>
                    </HierarchicalDataTemplate>
                </TreeView.ItemTemplate>
            </TreeView>

            <!-- Empty State -->
            <StackPanel
                Grid.Row="2"
                VerticalAlignment="Center"
                HorizontalAlignment="Center"
                Visibility="{Binding OutlineItems.Count, Converter={StaticResource ZeroToVisibility}}">

                <materialDesign:PackIcon
                    Kind="FileTree"
                    Width="64"
                    Height="64"
                    Foreground="{DynamicResource MaterialDesignBodyLight}"
                    HorizontalAlignment="Center" />

                <TextBlock
                    Text="No outline items yet"
                    Style="{StaticResource MaterialDesignHeadline6TextBlock}"
                    Foreground="{DynamicResource MaterialDesignBodyLight}"
                    HorizontalAlignment="Center"
                    Margin="0,16,0,0" />

                <TextBlock
                    Text="Add items manually or use AI to generate"
                    Style="{StaticResource MaterialDesignBody2TextBlock}"
                    Foreground="{DynamicResource MaterialDesignBodyLight}"
                    HorizontalAlignment="Center"
                    Margin="0,8,0,16" />

                <Button
                    Style="{StaticResource MaterialDesignRaisedButton}"
                    Command="{Binding GenerateOutlineCommand}"
                    HorizontalAlignment="Center">
                    <StackPanel Orientation="Horizontal">
                        <materialDesign:PackIcon Kind="AutoFix" Margin="0,0,8,0" />
                        <TextBlock Text="Generate Outline" />
                    </StackPanel>
                </Button>
            </StackPanel>
        </Grid>

        <!-- Splitter -->
        <GridSplitter
            Grid.Column="1"
            Width="4"
            HorizontalAlignment="Center"
            VerticalAlignment="Stretch"
            Background="{DynamicResource MaterialDesignDivider}" />

        <!-- Right Panel: Details -->
        <Grid Grid.Column="2">
            <!-- No Selection State -->
            <StackPanel
                VerticalAlignment="Center"
                HorizontalAlignment="Center"
                Visibility="{Binding SelectedItem, Converter={StaticResource NullToVisibility}}">

                <materialDesign:PackIcon
                    Kind="CursorPointer"
                    Width="48"
                    Height="48"
                    Foreground="{DynamicResource MaterialDesignBodyLight}"
                    HorizontalAlignment="Center" />

                <TextBlock
                    Text="Select an item to edit"
                    Style="{StaticResource MaterialDesignBody1TextBlock}"
                    Foreground="{DynamicResource MaterialDesignBodyLight}"
                    HorizontalAlignment="Center"
                    Margin="0,16,0,0" />
            </StackPanel>

            <!-- Details Panel -->
            <ScrollViewer
                VerticalScrollBarVisibility="Auto"
                Visibility="{Binding SelectedItem, Converter={StaticResource NotNullToVisibility}}">

                <StackPanel Margin="8,16,16,16">
                    <TextBlock
                        Text="Item Details"
                        Style="{StaticResource MaterialDesignHeadline6TextBlock}"
                        Margin="0,0,0,16" />

                    <!-- Type indicator -->
                    <materialDesign:Chip
                        Content="{Binding SelectedItem.Type}"
                        Margin="0,0,0,16" />

                    <!-- Title -->
                    <TextBox
                        Text="{Binding SelectedItem.Title, UpdateSourceTrigger=PropertyChanged}"
                        Style="{StaticResource MaterialDesignOutlinedTextBox}"
                        materialDesign:HintAssist.Hint="Title"
                        Margin="0,0,0,16" />

                    <!-- Description -->
                    <TextBox
                        Text="{Binding SelectedItem.Description, UpdateSourceTrigger=PropertyChanged}"
                        Style="{StaticResource MaterialDesignOutlinedTextBox}"
                        materialDesign:HintAssist.Hint="Description / Notes"
                        TextWrapping="Wrap"
                        AcceptsReturn="True"
                        MinHeight="150"
                        MaxHeight="300"
                        VerticalScrollBarVisibility="Auto"
                        Margin="0,0,0,16" />

                    <!-- Chapter Link -->
                    <materialDesign:Card
                        Padding="16"
                        Margin="0,0,0,16"
                        Visibility="{Binding SelectedItem.Type, Converter={StaticResource ChapterTypeVisibility}}">

                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>

                            <StackPanel>
                                <TextBlock
                                    Text="Chapter"
                                    Style="{StaticResource MaterialDesignSubtitle2TextBlock}" />
                                <TextBlock
                                    Text="Create a chapter from this outline item"
                                    Style="{StaticResource MaterialDesignCaptionTextBlock}"
                                    Foreground="{DynamicResource MaterialDesignBodyLight}" />
                            </StackPanel>

                            <Button
                                Grid.Column="1"
                                Style="{StaticResource MaterialDesignOutlinedButton}"
                                Command="{Binding CreateChapterFromItemCommand}"
                                CommandParameter="{Binding SelectedItem}"
                                IsEnabled="{Binding SelectedItem.HasLinkedChapter, Converter={StaticResource InvertedBoolConverter}}">
                                <StackPanel Orientation="Horizontal">
                                    <materialDesign:PackIcon Kind="FilePlus" Margin="0,0,8,0" />
                                    <TextBlock Text="Create Chapter" />
                                </StackPanel>
                            </Button>
                        </Grid>
                    </materialDesign:Card>

                    <!-- Linked Chapter Info -->
                    <materialDesign:Card
                        Padding="16"
                        Background="{DynamicResource PrimaryHueLightBrush}"
                        Visibility="{Binding SelectedItem.HasLinkedChapter, Converter={StaticResource BoolToVisibility}}">

                        <StackPanel Orientation="Horizontal">
                            <materialDesign:PackIcon
                                Kind="Link"
                                Width="24"
                                Height="24"
                                Margin="0,0,12,0"
                                VerticalAlignment="Center" />
                            <TextBlock
                                Text="This item is linked to a chapter"
                                VerticalAlignment="Center" />
                        </StackPanel>
                    </materialDesign:Card>
                </StackPanel>
            </ScrollViewer>
        </Grid>

        <!-- Generating Overlay -->
        <Border
            Grid.ColumnSpan="3"
            Background="#80000000"
            Visibility="{Binding IsGenerating, Converter={StaticResource BoolToVisibility}}">

            <materialDesign:Card
                VerticalAlignment="Center"
                HorizontalAlignment="Center"
                Padding="32">

                <StackPanel HorizontalAlignment="Center">
                    <ProgressBar
                        Style="{StaticResource MaterialDesignCircularProgressBar}"
                        IsIndeterminate="True"
                        Width="48"
                        Height="48"
                        Margin="0,0,0,16" />

                    <TextBlock
                        Text="Generating outline..."
                        Style="{StaticResource MaterialDesignHeadline6TextBlock}"
                        HorizontalAlignment="Center" />
                </StackPanel>
            </materialDesign:Card>
        </Border>
    </Grid>
</UserControl>
